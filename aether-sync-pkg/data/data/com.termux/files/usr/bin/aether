#!/data/data/com.termux/files/usr/bin/bash
# AETHER-SYNC v6.3.0 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
YELLOW="\033[1;33m"
GREEN="\033[1;32m"
RED="\033[1;31m"
RESET="\033[0m"

get_free_space() {
    df -h /data | awk 'NR==2 {print $4}' | sed 's/G//' | cut -d. -f1
}

phantom_write() {
    local target="$SHADOW$1"
    [ -e "$target" ] || [ -L "$target" ] && rm -rf "$target"
    mkdir -p "$(dirname "$target")"
    touch "$target" 2>/dev/null
}

sysinfo() {
    echo -e "${BLUE}--- AETHER SYSTEM REPORT ---${RESET}"
    echo -e "${CYAN}Kernel:${RESET} $(uname -r)"
    echo -e "${CYAN}Device:${RESET} $(getprop ro.product.model)"
    echo -e "${CYAN}Android Ver:${RESET} $(getprop ro.build.version.release)"
    echo -e "${CYAN}Storage Free:${RESET} $(get_free_space) GB"
    echo -e "${CYAN}Shadow Status:${RESET} $([ -d "$SHADOW/system" ] && echo -e "${GREEN}Active${RESET}" || echo -e "${RED}Inactive${RESET}")"
}

morph() {
    FREE=$(get_free_space)
    MODE="link"

    if [ "$FREE" -le 4 ]; then
        echo -e "${YELLOW}Warning: Please do not delete the cache and data using aether --kill, as we are in the emulation process. Low storage detected ($FREE GB).${RESET}"
    else
        echo -e "${CYAN}Attention: Do you want to perform a full emulation? [Y]yes, [N]no:${RESET} "
        read -n 1 -r user_choice
        echo
        [[ $user_choice =~ ^[Yy]$ ]] && MODE="full"
    fi

    echo -e "${BLUE}[AETHER]${RESET} Cloning Root File System..."
    ROOT_PATHS=("/acct" "/apex" "/bin" "/cache" "/config" "/data" "/dev" "/etc" "/mnt" "/odm" "/oem" "/proc" "/product" "/sdcard" "/storage" "/sys" "/system" "/system_ext" "/vendor")

    for p in "${ROOT_PATHS[@]}"; do
        if [ -d "$p" ]; then
            mkdir -p "$SHADOW$p"
            [ "$MODE" == "full" ] && cp -af "$p"/. "$SHADOW$p/" 2>/dev/null || cp -as "$p"/. "$SHADOW$p/" 2>/dev/null
        fi
    done

    phantom_write "/product/build.prop"
    phantom_write "/proc/cpuinfo"

    cat <<OP > "$SHADOW/.bashrc"
shopt -s nullglob
export PS1='~#aether\${PWD#$SHADOW}\$: '
alias cd='_cd(){ if [[ "\$1" == /* ]]; then builtin cd "$SHADOW\$1" 2>/dev/null || builtin cd "\$1"; else builtin cd "\$1"; fi; }; _cd'
alias ls='ls --color=auto -F'
alias aether='/data/data/com.termux/files/usr/bin/aether'
unset TERMUX_VERSION
export PREFIX="/system"
echo -e "${GREEN}Aether-Sync Global Environment Active.${RESET}"
OP
    cd "$SHADOW"
    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph ;;
    --sysinfo) sysinfo ;;
    --explore) 
        echo -e "${CYAN}Common Phantom Paths:${RESET}"
        echo -e "1) /data/data (Apps)\n2) /product (Build Props)\n3) /proc (System Info)"
        ;;
    --check-storage)
        echo -e "${YELLOW}Current Free Space: $(get_free_space) GB${RESET}"
        ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow data wiped." ;;
    *) echo "Usage: aether [--morph|--sysinfo|--explore|--check-storage|--kill]" ;;
esac
