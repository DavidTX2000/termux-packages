#!/data/data/com.termux/files/usr/bin/bash
# AETHER-SYNC v7.4.1

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
GREEN="\033[1;32m"
RESET="\033[0m"

morph() {
    # Aviso Original Amarelo [cite: 2026-01-29]
    echo -e "${YELLOW}Warning: Please do not delete the cache and data using aether --kill, as we are in the emulation process. Low storage detected (4 GB).${RESET}"

    if [ -z "$(ls -A "$SHADOW" 2>/dev/null)" ]; then
        echo -e "${BLUE}[AETHER]${RESET} Cloning Root File System..."
        mkdir -p "$SHADOW/aether_bin" "$SHADOW/root"
        
        # CLONAGEM PROFUNDA COM AVISOS OBRIGATÓRIOS [cite: 2026-01-26]
        # Pegando todas as pastas da raiz real para espelhar
        for p in $(ls -1 / 2>/dev/null); do
            echo -e "${BLUE}[AETHER]${RESET} Mirroring /$p..."
            mkdir -p "$SHADOW/$p" 2>/dev/null
            cp -asf "/$p"/. "$SHADOW/$p/" 2>/dev/null
            sleep 0.2 # Delay forçado para o design visual que você pediu
        done
        
        # INJEÇÃO DE IDENTIDADE ROOT (Fixing u0_a454 error) [cite: 2026-01-26]
        printf "#!/data/data/com.termux/files/usr/bin/bash\necho \"root\"\n" > "$SHADOW/aether_bin/whoami"
        printf "#!/data/data/com.termux/files/usr/bin/bash\necho \"uid=0(root) gid=0(root) groups=0(root)\"\n" > "$SHADOW/aether_bin/id"
        chmod 755 "$SHADOW/aether_bin/whoami" "$SHADOW/aether_bin/id"
        
        echo -e "${BLUE}[AETHER]${RESET} Mirroring Complete." [cite: 2026-01-26]
    fi

    # .bashrc: DESIGN CLÁSSICO (BRANCO) E HOME NA RAIZ (~#aether$:) [cite: 2026-01-26]
    cat <<'OP' > "$SHADOW/.bashrc"
# Força o aether_bin no topo do PATH para o whoami funcionar
export PATH="/aether_bin:/system/bin:/system/xbin:$PATH"
# PS1 Restaurado para o padrão branco e curto da imagem
export PS1='~#aether${PWD#$SHADOW}\$: '
alias ls='ls --color=auto -F'
alias cd='_cd(){ if [[ "$1" == /* ]]; then builtin cd "/data/data/com.termux/files/usr/share/aether/shadow$1" 2>/dev/null || builtin cd "$1"; else builtin cd "$1"; fi; }; _cd'
export HOME="/root"
cd /
echo -e "\033[1;32mAbsolute Mirror Active.\033[0m"
OP

    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow Purged." ;;
esac
