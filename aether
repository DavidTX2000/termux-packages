#!/data/data/com.termux/files/usr/bin/bash
# aether-sync - ADAPTIVE GHOST IA v41.0

SHADOW="/data/data/com.termux/files/usr/share/aether-sync/shadow"
BLUE="\033[1;34m"; GREEN="\033[1;32m"; YELLOW="\033[1;33m"; RESET="\033[0m"

# Salva o modelo real antes de entrar no isolamento
REAL_MODEL=$(getprop ro.product.model)
REAL_BRAND=$(getprop ro.product.brand)

detect_hardware() {
    echo -e "${BLUE}[IA]${RESET} Hardware Detected: $REAL_BRAND $REAL_MODEL"
}

morph_logic() {
    detect_hardware
    echo -e "${YELLOW}Warning: Emulation active. Zero-Detection Mode Engaged.${RESET}"
    
    # 1. BASE STRUCTURE
    DIRS=("/bin" "/system/bin" "/data/system" "/data/adb" "/proc" "/sys" "/dev")
    
    # 2. IA ADAPTIVE INJECTION
    if [[ "$REAL_BRAND" =~ [Ss]amsung ]]; then
        echo -e "${BLUE}[IA]${RESET} Injecting Samsung Forensic Layer (EFS/Knox/OneUI)..."
        DIRS+=("/efs/imei" "/efs/FactoryApp" "/sec_efs" "/carrier" "/system/priv-app/OneUI")
    elif [[ "$REAL_BRAND" =~ [Xx]iaomi ]]; then
        echo -e "${BLUE}[IA]${RESET} Injecting Xiaomi Forensic Layer..."
        DIRS+=("/data/system/miui" "/system/priv-app/MiuiHome" "/data/miui")
    fi

    for dir in "${DIRS[@]}"; do
        mkdir -p "$SHADOW$dir" 2>/dev/null
    done

    # 3. FIX: CLONING BUILD.PROP (Clean format)
    /system/bin/getprop | sed 's/\[//g; s/\]//g; s/: /=/g' > "$SHADOW/system/build.prop"

    # 4. GHOST BASHRC
    cat <<OP > "$SHADOW/.bashrc"
export SHADOW="$SHADOW"
export PATH="/bin:/system/bin:/data/data/com.termux/files/usr/bin"
export HOME="/root"
export MODEL_NAME="$REAL_MODEL"

whoami() { echo "root"; }
id() { echo "uid=0(root) gid=0(root) groups=0(root),1004(input),3003(inet)"; }
su() { echo "Aether: Access Granted (Ghost Mode)."; export PS1='~#aether-root$: '; }
export -f whoami id su

# Fixed getprop for internal use
getprop() { 
    if [ -z "\$1" ]; then cat /system/build.prop; 
    else grep "^\$1=" /system/build.prop | cut -d'=' -f2 || echo "unknown"; fi
}
export -f getprop

cat() { [[ "\$1" == /* ]] && [[ "\$1" != "$SHADOW"* ]] && command cat "$SHADOW\$1" 2>/dev/null || command cat "\$@"; }
ls() { [[ "\$1" == /* ]] && [[ "\$1" != "$SHADOW"* ]] && command ls --color=auto -F "$SHADOW\$1" 2>/dev/null || command ls --color=auto -F "\$@"; }
export -f cat ls

PS1_GEN() {
    if [ "\$PS1" != "~#aether-root$: " ]; then
        if [ "\$PWD" = "$SHADOW" ]; then export PS1='~#aether$: ';
        else export PS1='~#aether\${PWD#$SHADOW}\$: '; fi
    fi
}
PROMPT_COMMAND=PS1_GEN
builtin cd "\$SHADOW"
echo -e "\033[1;32mAdaptive Ghost Root Active. Environment matched to \$MODEL_NAME.\033[0m"
OP

    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph_logic ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow Purged." ;;
esac
